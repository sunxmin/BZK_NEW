<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <!-- ASP.NET Core 模块配置 -->
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>

      <!-- ASP.NET Core 进程配置 -->
      <aspNetCore
        processPath="dotnet"
        arguments=".\BZKQuerySystem.Web.dll"
        stdoutLogEnabled="true"
        stdoutLogFile=".\logs\stdout"
        hostingModel="inprocess"
        requestTimeout="00:20:00"
        startupTimeLimit="120"
        shutdownTimeLimit="10">
        <!-- 环境变量配置 -->
        <environmentVariables>
          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
          <environmentVariable name="ASPNETCORE_URLS" value="http://+:80" />
          <environmentVariable name="COMPlus_ReadyToRun" value="0" />
        </environmentVariables>
      </aspNetCore>

      <!-- HTTP响应头安全配置 -->
      <httpProtocol>
        <customHeaders>
          <add name="X-Content-Type-Options" value="nosniff" />
          <add name="X-Frame-Options" value="SAMEORIGIN" />
          <add name="X-XSS-Protection" value="1; mode=block" />
          <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
          <add name="Content-Security-Policy" value="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com fonts.googleapis.com; font-src 'self' fonts.gstatic.com cdn.jsdelivr.net; img-src 'self' data:;" />
        </customHeaders>
      </httpProtocol>

      <!-- 静态文件缓存配置 - 移除MIME映射避免冲突 -->
      <staticContent>
        <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00" />
      </staticContent>

            <!-- URL rewrite rules removed temporarily until URL Rewrite module is installed -->

      <!-- 压缩配置 - 使用IIS默认设置 -->
      <!-- <httpCompression>标签可能需要特定IIS功能，暂时移除 -->

      <!-- 请求过滤配置 -->
      <security>
        <requestFiltering>
          <requestLimits maxAllowedContentLength="52428800" />  <!-- 50MB -->
          <fileExtensions allowUnlisted="true">
            <remove fileExtension=".config" />
            <remove fileExtension=".cs" />
            <remove fileExtension=".vb" />
            <remove fileExtension=".dll" />
            <remove fileExtension=".exe" />
          </fileExtensions>
          <hiddenSegments>
            <add segment="bin" />
            <add segment="App_code" />
            <add segment="App_Data" />
            <add segment="logs" />
          </hiddenSegments>
        </requestFiltering>
      </security>

      <!-- 错误页面配置 -->
      <httpErrors errorMode="Custom" defaultResponseMode="ExecuteURL">
        <remove statusCode="404" subStatusCode="-1" />
        <remove statusCode="500" subStatusCode="-1" />
        <error statusCode="404" path="/Error/NotFound" responseMode="ExecuteURL" />
        <error statusCode="500" path="/Error/InternalError" responseMode="ExecuteURL" />
      </httpErrors>

      <!-- 默认文档配置 -->
      <defaultDocument>
        <files>
          <clear />
          <add value="index.html" />
          <add value="default.html" />
        </files>
      </defaultDocument>

      <!-- 缓存配置 - 使用简化版本避免扩展名冲突 -->
      <caching enabled="true" enableKernelCache="true" />

      <!-- WebSocket支持 -->
      <webSocket enabled="true" />

      <!-- 模块配置 -->
      <modules>
        <remove name="WebDAVModule" />
      </modules>

    </system.webServer>
  </location>

  <!-- 应用程序配置 -->
  <system.web>
    <compilation tempDirectory="%SystemRoot%\Microsoft.NET\Framework64\v4.0.30319\Temporary ASP.NET Files" />
    <httpRuntime maxRequestLength="51200" executionTimeout="600" />  <!-- 50MB, 10分钟 -->
  </system.web>

  <!-- 日志配置 -->
  <system.diagnostics>
    <trace autoflush="true">
      <listeners>
        <add name="textWriterTraceListener" type="System.Diagnostics.TextWriterTraceListener" initializeData="logs\trace.log" />
      </listeners>
    </trace>
  </system.diagnostics>

</configuration>
<!--
BZK查询系统 IIS 配置文件
项目GUID: AB3DB5B0-68F5-412B-AF24-24437BE4B549
配置版本: v1.0
创建日期: 2025年6月6日
适用环境: 生产环境
主要功能:
- ASP.NET Core 8.0 支持
- 安全头配置
- 静态文件缓存优化
- GZIP压缩
- Redis缓存支持
- SignalR WebSocket支持
- 错误处理
- 请求过滤和安全配置
-->
