# BZK查询系统 - IIS部署完成说明

## 📋 部署信息

**部署时间**: 2025年6月6日  
**部署路径**: `D:\BZKIIS\`  
**项目版本**: v2.0 (基于.NET 8.0)  
**部署状态**: ✅ 已完成  

## 🎯 部署内容

### 已部署的核心组件

1. **主应用程序**
   - `BZKQuerySystem.Web.dll` - 主应用程序
   - `BZKQuerySystem.Services.dll` - 业务逻辑层
   - `BZKQuerySystem.DataAccess.dll` - 数据访问层

2. **依赖库**
   - ASP.NET Core 8.0 运行时
   - Entity Framework Core 9.0.4
   - Redis缓存支持 (StackExchange.Redis 2.8.0)
   - Excel导出支持 (EPPlus 7.0.10)
   - PDF导出支持 (iText7)
   - SignalR实时通信支持

3. **静态资源**
   - `wwwroot/` - 前端资源文件
   - `ClientApp/` - 客户端应用程序
   - 多语言支持文件

## ⚙️ 配置文件

### 1. web.config (已优化)

**主要特性**:

- ✅ ASP.NET Core 8.0 模块配置
- ✅ 安全HTTP头配置
- ✅ GZIP压缩启用
- ✅ 静态文件缓存优化
- ✅ WebSocket支持 (SignalR)
- ✅ 错误处理和日志配置
- ✅ 请求过滤和安全配置
- ✅ URL重写规则

### 2. appsettings.Production.json (已更新)

**配置要点**:

- 数据库连接: `Server=localhost;Database=ZBKQuerySystem`
- Redis缓存: `localhost:6379,password=BZK_Redis_2025`
- 并发支持: 180用户
- 缓存策略: L1内存+L2Redis双层缓存
- 安全配置: 生产级安全设置

## 🔧 IIS配置要求

### 必需的IIS功能

1. **基础功能**
   - IIS管理控制台
   - 万维网服务
   - HTTP重定向
   - HTTP错误

2. **应用程序开发**
   - ASP.NET Core模块 v2
   - WebSocket协议
   - 服务器端包含

3. **性能功能**
   - 静态内容压缩
   - 动态内容压缩

4. **安全功能**
   - 请求筛选
   - URL授权

### 应用程序池配置

```
名称: BZKQuerySystem
.NET CLR版本: 无托管代码
托管管道模式: 集成
标识: ApplicationPoolIdentity
启动模式: AlwaysRunning
空闲超时: 0 (不超时)
```

## 📁 目录权限设置

需要为以下目录设置适当权限:

1. **应用程序根目录** (`D:\BZKIIS\`)
   - IIS_IUSRS: 读取和执行
   - ApplicationPoolIdentity: 读取和执行

2. **日志目录** (`D:\BZKIIS\logs\`)
   - IIS_IUSRS: 完全控制
   - ApplicationPoolIdentity: 完全控制

3. **导出目录** (`D:\BZKIIS\wwwroot\exports\`)
   - IIS_IUSRS: 完全控制
   - ApplicationPoolIdentity: 完全控制

## 🗄️ 数据库配置

### SQL Server要求

1. **数据库**: `ZBKQuerySystem`
2. **用户**: `sa` (密码: `123`)
3. **权限**: db_owner
4. **连接池**: 10-200连接

### 数据库初始化

```sql
-- 创建数据库
CREATE DATABASE ZBKQuerySystem;

-- 设置数据库选项
ALTER DATABASE ZBKQuerySystem SET RECOVERY SIMPLE;
ALTER DATABASE ZBKQuerySystem SET AUTO_CLOSE OFF;
ALTER DATABASE ZBKQuerySystem SET AUTO_SHRINK OFF;
```

## 🔴 Redis缓存配置

### Redis服务要求

1. **服务器**: `localhost:6379`
2. **密码**: `BZK_Redis_2025`
3. **内存**: 建议2GB以上
4. **持久化**: 启用RDB和AOF

### Redis启动命令

```bash
redis-server --requirepass BZK_Redis_2025 --maxmemory 2gb --maxmemory-policy allkeys-lru
```

## 🚀 启动步骤

### 1. 创建IIS网站

1. 打开IIS管理器
2. 右键"网站" → "添加网站"
3. 配置信息:
   - 网站名称: `BZKQuerySystem`
   - 物理路径: `D:\BZKIIS\`
   - 端口: `80` (或其他可用端口)

### 2. 配置应用程序池

1. 选择应用程序池
2. 设置为"无托管代码"
3. 启用"AlwaysRunning"

### 3. 设置权限

```powershell
# 设置目录权限
icacls "D:\BZKIIS" /grant "IIS_IUSRS:(OI)(CI)RX"
icacls "D:\BZKIIS\logs" /grant "IIS_IUSRS:(OI)(CI)F"
icacls "D:\BZKIIS\wwwroot\exports" /grant "IIS_IUSRS:(OI)(CI)F"
```

### 4. 启动服务

1. 启动Redis服务
2. 确认SQL Server运行
3. 启动IIS网站
4. 访问网站验证

## 📊 性能监控

### 关键指标

- **响应时间**: < 3秒
- **并发用户**: 180用户
- **内存使用**: < 2GB
- **CPU使用**: < 75%
- **缓存命中率**: > 70%

### 监控端点

- 健康检查: `/health`
- 系统监控: `/monitoring`
- Redis状态: `/health/redis`
- 数据库状态: `/health/database`

## 🔍 故障排除

### 常见问题

1. **500.19错误**
   - 检查ASP.NET Core模块是否安装
   - 验证web.config语法

2. **500.30错误**
   - 检查应用程序池配置
   - 查看事件日志

3. **Redis连接失败**
   - 确认Redis服务运行
   - 检查密码配置

4. **数据库连接失败**
   - 验证SQL Server服务
   - 检查连接字符串

### 日志位置

- **应用程序日志**: `D:\BZKIIS\logs\`
- **IIS日志**: `C:\inetpub\logs\LogFiles\`
- **Windows事件日志**: 事件查看器 → Windows日志 → 应用程序

## 📞 技术支持

如遇到部署问题，请检查:

1. ✅ .NET 8.0 Runtime已安装
2. ✅ ASP.NET Core模块已安装
3. ✅ Redis服务正常运行
4. ✅ SQL Server服务正常运行
5. ✅ 防火墙端口已开放
6. ✅ 目录权限设置正确

---

**部署完成**: BZK查询系统已成功部署到 `D:\BZKIIS\` 目录，可以通过IIS进行访问。
