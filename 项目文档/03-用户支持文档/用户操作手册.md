# 专病多维度查询系统 - 用户操作手册

**文档版本**: v2.1  
**更新日期**: 2025年1月2日  
**系统版本**: BZK查询系统 v2.0  
**适用范围**: 所有系统用户

## 目录

1. [系统概述](#系统概述)
2. [界面介绍](#界面介绍)
3. [基础操作](#基础操作)
4. [高级功能](#高级功能)
5. [数据可视化](#数据可视化)
6. [导出功能](#导出功能)
7. [权限管理](#权限管理)
8. [常见问题](#常见问题)

---

## 系统概述

### 系统简介

专病多维度查询系统是一个可视化的SQL查询构建工具，帮助用户无需编写复杂SQL语句即可进行数据查询。系统支持多表关联查询、条件筛选、排序、数据导出、图表生成等功能。

### 主要功能

- **可视化查询构建**: 通过拖拽和选择完成查询构建
- **多表关联查询**: 支持内连接、左连接、右连接、全连接
- **灵活的条件筛选**: 支持多种比较操作符和复杂条件
- **自定义排序**: 支持多级排序规则
- **查询结果分页显示**: 可调整每页显示数量
- **保存和分享查询**: 查询保存与用户间分享
- **Excel和PDF导出**: 多格式数据导出功能
- **数据可视化**: 基于Chart.js的图表生成
- **实时通信**: SignalR实现的状态推送
- **权限管理**: 基于角色的访问控制

---

## 界面介绍

### 主界面布局

系统界面分为以下主要区域：

#### 顶部操作栏

- **<i class="fas fa-play"></i> 执行查询**: 运行当前构建的查询
- **<i class="fas fa-save"></i> 保存查询**: 将当前查询保存以便后续使用
- **<i class="fas fa-file-excel"></i> 导出Excel**: 将查询结果导出为Excel文件
- **<i class="fas fa-file-pdf"></i> 导出PDF**: 将查询结果导出为PDF文件（需要权限）

#### 左侧导航面板

- **已保存的查询**: 显示您保存的查询和他人分享给您的查询
  - <i class="fas fa-bookmark"></i> 个人创建的查询
  - <i class="fas fa-share"></i> 他人分享的查询
  - 显示查询创建者和分享状态
- **可用表和视图**: 显示系统中可查询的数据表和预定义视图
  - <i class="fas fa-table"></i> 数据表
  - <i class="fas fa-chart-line"></i> 视图
  - <i class="fas fa-search"></i> 搜索功能

#### 右侧主工作区

- **查询构建器**: 用于构建查询条件的主要工作区
- **查询结果**: 显示查询执行后的数据结果
- **操作工具栏**:
  - <i class="fas fa-chart-bar"></i> 图表：数据可视化
  - <i class="fas fa-calculator"></i> 统计：查看统计信息
  - <i class="fas fa-tasks"></i> 任务：导出任务管理

---

## 基础操作

### 1. 选择数据表

#### 操作步骤

1. 在左侧"可用表和视图"面板中浏览可用的数据表
2. 使用搜索框快速查找特定的表
3. 点击表名将其添加到查询中
4. 已选择的表会显示在"选择表"区域

#### 图标说明

- <i class="fas fa-table"></i> 表图标表示数据表
- <i class="fas fa-chart-line"></i> 图表图标表示预定义视图
- 可以选择多个表进行关联查询

### 2. 选择查询列

#### 操作步骤

1. 在"选择列"区域，从下拉菜单中选择要查询的表
2. 在"可用列"多选框中选择需要的字段
3. 可以使用"全选"复选框选择表的所有列
4. 点击"添加选中的列"按钮
5. 已选择的列会以网格形式显示

#### 列信息显示

- 列名和数据类型
- <i class="fas fa-key"></i> 主键标识
- 是否可空标识
- 列描述信息

#### 列顺序调整 🆕

当您选择了2列或以上时，可以通过拖拽来调整列的显示顺序：

1. **识别拖拽手柄**: 每个已选列左侧都有一个拖拽手柄图标（⋮⋮）
2. **开始拖拽**: 将鼠标悬停在拖拽手柄上，光标会变成抓取状态
3. **拖拽操作**: 按住鼠标左键并拖拽列到目标位置
4. **位置预览**: 拖拽过程中会显示蓝色线条指示插入位置
5. **完成排序**: 松开鼠标完成排序，系统会显示"列顺序已更新"提示

**拖拽排序优势**:

- **直观操作**: 所见即所得的排序方式
- **实时同步**: 拖拽完成后SQL预览和查询结果立即更新
- **精确定位**: 可以拖拽到任意位置，支持精确排序

**注意事项**:

- 只有点击拖拽手柄（⋮⋮）才能触发拖拽，避免误操作
- 在移动设备上，拖拽手柄会更大更容易操作
- 列顺序的改变会直接影响查询结果中列的显示顺序

#### 提示

- 支持搜索功能，可快速找到需要的字段
- 点击列旁边的"×"按钮可以移除不需要的列
- 如果不选择任何列，系统默认查询所有列（SELECT *）
- 🆕 使用拖拽排序功能可以快速调整查询结果中列的显示顺序

### 3. 设置查询条件

#### 操作步骤

1. 在"查询条件"区域选择要筛选的列
2. 选择比较操作符
3. 输入条件值（某些操作符不需要值）
4. 点击"添加"按钮

#### 支持的操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `=` | 等于 | 姓名 = '张三' |
| `<>` | 不等于 | 状态 <> '已删除' |
| `>` | 大于 | 年龄 > 18 |
| `<` | 小于 | 费用 < 1000 |
| `>=` | 大于等于 | 日期 >= '2024-01-01' |
| `<=` | 小于等于 | 数量 <= 100 |
| `LIKE` | 包含 | 姓名 LIKE '%张%' |
| `NOT LIKE` | 不包含 | 备注 NOT LIKE '%测试%' |
| `IN` | 在列表中 | 状态 IN ('待审','已审') |
| `NOT IN` | 不在列表中 | 类型 NOT IN ('无效') |
| `IS NULL` | 为空 | 备注 IS NULL |
| `IS NOT NULL` | 不为空 | 电话 IS NOT NULL |
| `BETWEEN` | 范围内 | 日期 BETWEEN '2024-01-01' AND '2024-12-31' |

#### 特殊操作符说明

- **LIKE**: 自动添加通配符，输入"张"会查找包含"张"的所有记录
- **IN/NOT IN**: 输入多个值时用逗号分隔，如：`值1,值2,值3`
- **BETWEEN**: 输入范围值，格式：`起始值 AND 结束值`

### 4. 设置排序规则

#### 操作步骤

1. 在"排序设置"区域选择要排序的列
2. 选择排序方向：
   - 升序：从小到大
   - 降序：从大到小
3. 点击"添加排序"按钮
4. 可以添加多个排序条件，按添加顺序执行

### 5. 执行查询

#### 操作步骤

1. 确认查询条件设置完成
2. 查看SQL预览确认查询语句正确
3. 点击顶部的"<i class="fas fa-play"></i> 执行查询"按钮
4. 查询结果会显示在下方的表格中

#### 结果查看

- 表格显示查询结果，支持横向和纵向滚动
- 显示总记录数和查询耗时
- 支持分页浏览，可调整每页显示数量（10/20/50/100）
- 表头固定，滚动时始终可见

---

## 高级功能

### 1. 多表关联查询

#### 关联类型说明

| 关联类型 | 说明 | 使用场景 |
|----------|------|----------|
| **内连接（INNER JOIN）** | 只返回两表中都有匹配的记录 | 获取完整关联数据 |
| **左连接（LEFT JOIN）** | 返回左表所有记录，右表匹配的记录 | 保留主表所有数据 |
| **右连接（RIGHT JOIN）** | 返回右表所有记录，左表匹配的记录 | 保留关联表所有数据 |
| **全连接（FULL JOIN）** | 返回两表的所有记录 | 获取完整数据集 |

#### 设置关联操作

1. 首先选择主表（第一个表）
2. 添加第二个表到查询中
3. 在"表关联设置"区域：
   - 选择关联类型
   - 选择要关联的表
   - 选择源表字段和关联表字段
   - 点击"添加关联"
4. 重复步骤3可添加更多表的关联

#### 多表查询列名显示

- 在多表查询中，所有列名都会显示为"表名.列名"格式
- 这样可以清楚地知道每个数据来自哪个表

### 2. 保存和管理查询

#### 保存查询

1. 构建完查询后，点击"<i class="fas fa-save"></i> 保存查询"按钮
2. 输入查询名称（必填）
3. 输入查询描述（可选）
4. 点击"保存"

#### 查询保存规则

- **重要**: 如果修改了查询内容，必须修改查询名称才能保存
- 如果只修改查询名称，会创建一个新的查询
- 如果查询内容和名称都未改变，不需要保存

#### 管理已保存的查询

- **加载查询**: 在左侧"已保存的查询"面板中点击查询名称
- **删除查询**: 点击查询右侧的<i class="fas fa-trash-alt"></i>图标（仅限创建者）
- **查看详情**: 显示创建时间、修改时间等信息

### 3. 查询分享功能

#### 分享查询

1. 在已保存的查询列表中找到要分享的查询
2. 点击分享图标<i class="fas fa-share"></i>（只有查询创建者可见）
3. 在弹出窗口中选择要分享的用户
4. 点击"确认分享设置"

#### 分享状态显示

- 已分享的查询会显示"已分享"标识
- 会显示分享给了哪些用户
- 接收到的分享查询会显示"此查询由XXX分享给您"

#### 权限说明

- 只能删除自己创建的查询
- 只能分享自己创建的查询
- 接收分享的查询可以查看和使用，但不能修改原查询

---

## 数据可视化

### 1. 图表功能概述

系统集成了Chart.js 4.4.0，提供基础的数据可视化功能。在查询执行完成后，可以点击结果区域的"<i class="fas fa-chart-bar"></i> 图表"按钮进入可视化模式。

### 2. 图表类型

目前支持的图表类型包括：

- **柱状图**: 适用于分类数据比较
- **折线图**: 适用于趋势分析和时间序列
- **饼图**: 适用于比例分析
- **散点图**: 适用于相关性分析
- **面积图**: 适用于累积分析

### 3. 创建图表

#### 基本步骤

1. 执行查询获取数据结果
2. 点击"<i class="fas fa-chart-bar"></i> 图表"按钮
3. 在弹出的可视化窗口中选择图表类型
4. 配置图表参数（X轴、Y轴字段等）
5. 点击生成图表

#### 图表配置

- **图表类型选择**: 从下拉菜单选择合适的图表类型
- **数据字段配置**: 设置X轴和Y轴使用的数据字段
- **图表标题**: 自定义图表显示标题
- **颜色主题**: 选择图表配色方案

### 4. 图表操作

- **下载图表**: 将图表保存为图片文件
- **全屏查看**: 全屏模式查看图表
- **重置图表**: 重新配置图表参数

### 5. 图表模板管理

#### 功能概述

图表模板功能允许您保存常用的图表配置，避免重复设置相同的图表参数，显著提高数据分析效率。模板包含图表类型、字段配置、标题设置等完整信息。

#### 模板保存功能

**操作步骤**：

1. 在可视化窗口中完成图表配置（选择图表类型、设置字段、输入标题等）
2. 点击图表标题输入框右侧的 <i class="fas fa-save"></i> 保存按钮
3. 在弹出的对话框中输入模板名称（必填）
4. 可选输入模板描述（推荐填写，便于后续识别）
5. 点击"保存模板"按钮完成保存

**保存规则**：

- 模板名称不能重复，如果重复系统会提示
- 模板自动记录创建时间和完整的图表配置信息
- 每个用户的模板独立存储，不会影响其他用户

#### 模板加载功能

**操作步骤**：

1. 在可视化窗口中，点击图表类型选择框旁边的 <i class="fas fa-folder-open"></i> 加载按钮
2. 在下拉列表中选择要加载的模板（显示模板名称和创建时间）
3. 系统会自动检查字段兼容性：
   - ✅ **兼容**：直接加载模板配置到表单
   - ⚠️ **部分兼容**：加载可用字段，提示不兼容的字段
   - ❌ **不兼容**：显示详细的不兼容原因
4. 根据需要调整加载后的配置
5. 点击"生成图表"查看效果

**智能兼容性检查**：

- **X轴字段**: 检查当前查询结果是否包含模板中的X轴字段
- **Y轴字段**: 检查当前查询结果是否包含模板中的Y轴字段  
- **字段类型**: 验证字段数据类型是否适合当前图表类型
- **清晰提示**: 详细说明哪些字段兼容/不兼容及原因

#### 模板管理功能

**查看模板列表**：

- 在模板加载下拉框中可以看到所有已保存的模板
- 显示信息包括：模板名称、创建时间、描述（如果有）
- 按创建时间倒序排列，最新的模板显示在最前面

**删除模板**：

1. 在模板加载下拉列表中找到要删除的模板
2. 点击模板右侧的 <i class="fas fa-trash-alt"></i> 删除按钮
3. 在确认对话框中点击"确认删除"
4. 模板删除后立即从列表中移除

**删除确认机制**：

- 删除操作不可撤销，系统会显示确认对话框
- 确认对话框会显示要删除的模板名称和创建时间
- 只有确认后才会执行删除操作

#### 使用技巧和最佳实践

**模板命名建议**：

- 使用描述性名称，如"月度销售趋势图"、"部门人员分布饼图"
- 包含图表类型信息，便于快速识别
- 避免使用过于简单的名称如"图表1"、"模板A"

**模板组织建议**：

- 为不同业务场景创建专门的模板
- 在模板描述中记录适用的数据条件
- 定期清理不再使用的旧模板

**效率提升技巧**：

- 为经常使用的图表配置创建模板
- 利用字段兼容性检查快速适配不同数据
- 在团队中分享优秀的图表配置经验

#### 故障排除

**Q: 为什么模板加载后字段显示为空？**
A: 这表示当前查询结果中没有模板所需的字段，请：

- 检查查询是否包含模板中使用的字段
- 确认字段名称是否完全匹配（区分大小写）
- 如果是多表查询，确认是否选择了正确的表字段

**Q: 模板加载时提示"部分不兼容"怎么办？**
A: 系统会详细显示不兼容的字段和原因：

- 查看提示信息，了解具体不兼容的字段
- 手动调整不兼容的字段选择
- 其他兼容的配置会自动加载，只需修改问题字段

**Q: 保存模板时提示名称重复？**
A: 模板名称必须唯一，请：

- 修改模板名称，添加版本号或日期
- 如果是更新现有模板，可以先删除旧版本再保存
- 使用更具描述性的名称避免冲突

**Q: 模板列表为空或显示异常？**
A: 可能的解决方法：

- 刷新页面重新加载模板列表
- 检查浏览器是否禁用了本地存储
- 确认之前确实保存过模板

#### 数据存储说明

- 图表模板使用浏览器本地存储（localStorage）保存
- 数据仅存储在当前浏览器中，不会传输到服务器
- 清除浏览器数据或更换浏览器会导致模板丢失
- 建议定期备份重要的图表配置信息

---

## 导出功能

### 1. Excel导出

#### 功能特性

- 完整数据导出，不受分页限制
- 保持数据格式和类型
- 支持大数据量导出
- 自动添加表头和筛选功能

#### 导出操作

1. 执行查询获得结果
2. 点击顶部的"<i class="fas fa-file-excel"></i> 导出Excel"按钮
3. 系统会生成Excel文件并自动下载
4. 文件名格式：`查询名称_日期时间.xlsx`

### 2. PDF导出

#### 功能特性（需要导出权限）

- 高质量PDF输出，适合打印
- 完美支持中文字体显示
- 智能表格分页处理
- 自定义页面布局和标题

#### 导出操作

1. 执行查询获得结果
2. 点击"<i class="fas fa-file-pdf"></i> 导出PDF"按钮（需要相应权限）
3. 系统后台生成PDF文件
4. 文件生成完成后自动下载

#### PDF导出配置

- 支持A4和A3页面尺寸
- 可选择页面方向（竖向/横向）
- 自定义报告标题
- 智能表格分页，避免内容截断

### 3. 导出任务管理

#### 任务跟踪

- 点击"<i class="fas fa-tasks"></i> 任务"按钮查看导出任务状态
- 显示正在进行、已完成、失败的导出任务
- 支持大文件异步导出，不阻塞其他操作

#### 任务状态

- **进行中**: 显示导出进度
- **已完成**: 可重新下载文件
- **失败**: 显示失败原因

---

## 权限管理

### 1. 用户权限体系

#### 权限级别

- **普通用户**: 基础查询功能
- **高级用户**: 查询保存和分享功能  
- **数据分析师**: 完整导出和分析功能
- **系统管理员**: 用户管理和系统配置

#### 功能权限矩阵

| 功能模块 | 普通用户 | 高级用户 | 分析师 | 管理员 |
|----------|----------|----------|--------|--------|
| 查询构建 | ✓ | ✓ | ✓ | ✓ |
| 保存查询 | ✗ | ✓ | ✓ | ✓ |
| 分享查询 | ✗ | ✓ | ✓ | ✓ |
| Excel导出 | ✗ | ✓ | ✓ | ✓ |
| PDF导出 | ✗ | ✗ | ✓ | ✓ |
| 数据可视化 | ✓ | ✓ | ✓ | ✓ |
| 用户管理 | ✗ | ✗ | ✗ | ✓ |

### 2. 数据访问控制

#### 表级权限

- 用户只能查询有权限访问的表和视图
- 系统管理员可以配置用户对特定表的访问权限
- 不同用户可能看到不同的表列表

#### 权限提示

- 无权限的功能按钮会被隐藏或禁用
- 权限不足时会显示相应的提示信息
- 所有操作都会进行权限验证

---

## 常见问题

### Q1: 为什么我看不到某些表？

**A**: 可能的原因：

- 您没有访问该表的权限
- 表名可能不同，尝试使用搜索功能
- 联系系统管理员确认权限设置

### Q2: 查询执行很慢怎么办？

**A**: 优化建议：

- 添加适当的查询条件缩小数据范围
- 避免查询过大的数据表
- 只选择需要的列，避免使用SELECT *
- 联系管理员检查数据库性能

### Q3: 为什么保存查询时提示"未修改"？

**A**: 这表示：

- 查询内容和名称都没有变化
- 系统认为不需要重复保存
- 如需保存新版本，请修改查询名称

### Q4: 多表查询时列名显示格式？

**A**: 系统设计：

- 多表查询时所有列都显示为"表名.列名"格式
- 单表查询时只显示列名
- 这样可以清楚区分数据来源

### Q5: 如何取消已经设置的条件？

**A**: 操作方法：

- 点击条件右侧的"×"按钮删除单个条件
- 使用"清空所有条件"按钮删除所有条件
- 同样适用于排序、关联等设置

### Q6: 为什么无法导出PDF？

**A**: 可能原因：

- 您没有PDF导出权限（需要数据分析师或更高权限）
- 查询结果为空
- 系统正在处理其他导出任务

### Q7: 图表显示异常怎么办？

**A**: 解决方法：

- 确认查询结果包含适合生成图表的数据
- 检查字段类型是否匹配图表要求
- 尝试刷新页面重新生成图表

### Q8: 如何使用图表模板功能？

**A**: 图表模板使用方法：

- **保存模板**: 配置好图表后，点击标题框右侧的保存按钮
- **加载模板**: 点击图表类型旁的文件夹图标，选择已保存的模板
- **兼容性**: 系统会自动检查字段兼容性，并给出详细提示
- **管理模板**: 可以查看、删除不需要的模板
- **注意事项**: 模板存储在浏览器本地，清除浏览器数据会丢失模板

---

## 系统提示

### 数据安全

- 查询操作是只读的，不会修改数据库数据
- 导出的数据请妥善保管，注意数据安全
- 分享查询时请确认接收人的权限范围

### 性能优化

- 大数据量查询时建议添加时间范围等限制条件
- 避免在高峰时段执行复杂查询
- 合理使用分页功能查看结果

### 系统使用

- 建议使用现代浏览器（Chrome、Firefox、Edge等）
- 确保网络连接稳定
- 定期保存重要的查询设置

### 界面操作

- 表格支持横向滚动查看更多列
- 表头固定，滚动时始终可见
- 支持鼠标悬停查看完整内容

---

## 技术支持

如果在使用过程中遇到问题，请：

1. 首先查阅本操作手册的常见问题部分
2. 检查查询条件和权限设置
3. 联系系统管理员或技术支持团队
4. 提供详细的错误信息和操作步骤

---

**版本信息**: v2.1  
**更新日期**: 2025年1月2日  
**适用系统**: 专病多维度查询系统  

---

*本手册将根据系统更新持续完善，请关注最新版本。*
