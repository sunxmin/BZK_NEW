# ç›‘æ§æœåŠ¡å…³é—­ä¼˜åŒ–è¯´æ˜

## ğŸ” é—®é¢˜æè¿°

å½“æ‚¨åœæ­¢`dotnet run`æ—¶ï¼Œç»ˆç«¯ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

```
fail: BZKQuerySystem.Services.AdvancedMonitoringService[0]
      ç›‘æ§æœåŠ¡æ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯
      System.Threading.Tasks.TaskCanceledException: A task was canceled.
         at BZKQuerySystem.Services.AdvancedMonitoringService.ExecuteAsync(CancellationToken stoppingToken)
```

## ğŸ“‹ é—®é¢˜åŸå› 

è¿™ä¸ªé”™è¯¯æ˜¯ç”±äº`AdvancedMonitoringService`åå°æœåŠ¡åœ¨åº”ç”¨ç¨‹åºå…³é—­æ—¶æ²¡æœ‰æ­£ç¡®å¤„ç†`CancellationToken`å¯¼è‡´çš„ï¼š

### åŸå§‹é—®é¢˜ä»£ç 

```csharp
while (!stoppingToken.IsCancellationRequested)
{
    try
    {
        await CollectMetricsAsync();
        await CleanupOldDataAsync();
        await Task.Delay(TimeSpan.FromSeconds(_settings.SamplingIntervalSeconds), stoppingToken);
    }
    catch (Exception ex)  // è¿™é‡Œæ•è·äº†æ‰€æœ‰å¼‚å¸¸ï¼ŒåŒ…æ‹¬TaskCanceledException
    {
        _logger.LogError(ex, "ç›‘æ§æœåŠ¡æ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯");
        await Task.Delay(TimeSpan.FromSeconds(60), stoppingToken); // è¿™é‡Œåˆä¼šæŠ›å‡ºTaskCanceledException
    }
}
```

### é—®é¢˜åˆ†æ

1. **åº”ç”¨ç¨‹åºå…³é—­æ—¶**ï¼š`CancellationToken`è¢«è§¦å‘
2. **Task.Delayè¢«å–æ¶ˆ**ï¼šæŠ›å‡º`TaskCanceledException`
3. **å¼‚å¸¸è¢«é”™è¯¯å¤„ç†**ï¼šé€šç”¨å¼‚å¸¸å¤„ç†æ•è·äº†å–æ¶ˆå¼‚å¸¸ï¼Œå¹¶è®°å½•ä¸ºé”™è¯¯
4. **äºŒæ¬¡é”™è¯¯**ï¼šé”™è¯¯å¤„ç†ä¸­çš„`Task.Delay`å†æ¬¡è¢«å–æ¶ˆï¼Œå¯¼è‡´åŒé‡é”™è¯¯

## âœ… è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹`AdvancedMonitoringService.ExecuteAsync`æ–¹æ³•ï¼Œæ­£ç¡®å¤„ç†åº”ç”¨ç¨‹åºå…³é—­åœºæ™¯ï¼š

### ä¼˜åŒ–åçš„ä»£ç 

```csharp
while (!stoppingToken.IsCancellationRequested)
{
    try
    {
        await CollectMetricsAsync();
        await CleanupOldDataAsync();
        await Task.Delay(TimeSpan.FromSeconds(_settings.SamplingIntervalSeconds), stoppingToken);
    }
    catch (OperationCanceledException) when (stoppingToken.IsCancellationRequested)
    {
        // åº”ç”¨ç¨‹åºæ­£åœ¨å…³é—­ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œä¸éœ€è¦è®°å½•é”™è¯¯
        _logger.LogInformation("ç›‘æ§æœåŠ¡æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­...");
        break;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "ç›‘æ§æœåŠ¡æ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯");
        
        // åœ¨é”™è¯¯æƒ…å†µä¸‹ç­‰å¾…ï¼Œä½†è¦æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
        try
        {
            await Task.Delay(TimeSpan.FromSeconds(60), stoppingToken);
        }
        catch (OperationCanceledException) when (stoppingToken.IsCancellationRequested)
        {
            _logger.LogInformation("ç›‘æ§æœåŠ¡åœ¨é”™è¯¯ç­‰å¾…æœŸé—´æ”¶åˆ°åœæ­¢ä¿¡å·");
            break;
        }
    }
}
```

## ğŸ¯ ä¼˜åŒ–è¦ç‚¹

### 1. **ä¸“é—¨å¤„ç†å–æ¶ˆå¼‚å¸¸**

```csharp
catch (OperationCanceledException) when (stoppingToken.IsCancellationRequested)
{
    // æ­£å¸¸å…³é—­ï¼Œè®°å½•ä¿¡æ¯è€Œéé”™è¯¯
    _logger.LogInformation("ç›‘æ§æœåŠ¡æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­...");
    break;
}
```

### 2. **åµŒå¥—å–æ¶ˆå¤„ç†**

```csharp
try
{
    await Task.Delay(TimeSpan.FromSeconds(60), stoppingToken);
}
catch (OperationCanceledException) when (stoppingToken.IsCancellationRequested)
{
    _logger.LogInformation("ç›‘æ§æœåŠ¡åœ¨é”™è¯¯ç­‰å¾…æœŸé—´æ”¶åˆ°åœæ­¢ä¿¡å·");
    break;
}
```

### 3. **ä½¿ç”¨æ¡ä»¶å¼‚å¸¸è¿‡æ»¤å™¨**

- `when (stoppingToken.IsCancellationRequested)` ç¡®ä¿åªå¤„ç†çœŸæ­£çš„å…³é—­å–æ¶ˆ
- é¿å…å¤„ç†å…¶ä»–ç±»å‹çš„`OperationCanceledException`

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ åº”ç”¨ç¨‹åºå…³é—­æ—¶æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
- âŒ `TaskCanceledException`è¢«é”™è¯¯åœ°è®°å½•ä¸ºç›‘æ§æœåŠ¡é”™è¯¯
- âŒ å¯èƒ½å‡ºç°åŒé‡å¼‚å¸¸

### ä¿®å¤å

- âœ… åº”ç”¨ç¨‹åºæ­£å¸¸å…³é—­ï¼Œæ— é”™è¯¯æ—¥å¿—
- âœ… æ˜¾ç¤ºå‹å¥½çš„ä¿¡æ¯æ—¥å¿—ï¼š"ç›‘æ§æœåŠ¡æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­..."
- âœ… ä¼˜é›…çš„æœåŠ¡å…³é—­æµç¨‹

## ğŸ” éªŒè¯æ–¹æ³•

1. **å¯åŠ¨åº”ç”¨ç¨‹åº**ï¼š

   ```bash
   cd BZKQuerySystem.Web && dotnet run
   ```

2. **æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿ**ï¼šè®¿é—®ç›‘æ§é¡µé¢ç­‰

3. **åœæ­¢åº”ç”¨ç¨‹åº**ï¼šæŒ‰`Ctrl+C`

4. **æ£€æŸ¥æ—¥å¿—**ï¼šåº”è¯¥çœ‹åˆ°ï¼š

   ```
   info: BZKQuerySystem.Services.AdvancedMonitoringService[0]
         ç›‘æ§æœåŠ¡æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­...
   info: BZKQuerySystem.Services.AdvancedMonitoringService[0]
         é«˜çº§ç›‘æ§æœåŠ¡å·²åœæ­¢
   ```

## ğŸ“š æŠ€æœ¯åŸç†

è¿™ä¸ªä¼˜åŒ–éµå¾ªäº†.NET Coreåå°æœåŠ¡çš„æœ€ä½³å®è·µï¼š

1. **æ­£ç¡®å¤„ç†CancellationToken**ï¼šåŒºåˆ†æ­£å¸¸å…³é—­å’Œå¼‚å¸¸æƒ…å†µ
2. **ä¼˜é›…å…³é—­**ï¼šç¡®ä¿æœåŠ¡èƒ½å¤Ÿæ­£å¸¸å“åº”å…³é—­ä¿¡å·
3. **é€‚å½“çš„æ—¥å¿—çº§åˆ«**ï¼šå…³é—­ä¿¡å·ä½¿ç”¨Informationè€ŒéErrorçº§åˆ«
4. **å¼‚å¸¸è¿‡æ»¤å™¨**ï¼šä½¿ç”¨`when`æ¡ä»¶ç²¾ç¡®æ§åˆ¶å¼‚å¸¸å¤„ç†

è¿™æ ·çš„å¤„ç†æ–¹å¼ç¡®ä¿äº†åº”ç”¨ç¨‹åºå…³é—­æ—¶çš„ç”¨æˆ·ä½“éªŒæ›´åŠ å‹å¥½ï¼Œä¸ä¼šå‡ºç°ä»¤äººå›°æƒ‘çš„é”™è¯¯ä¿¡æ¯ã€‚
